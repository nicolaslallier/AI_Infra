# ============================================
# PostgreSQL Configuration
# AI Infrastructure Project
# ============================================

# ---------------------------------------------
# CONNECTION SETTINGS
# ---------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# ---------------------------------------------
# MEMORY SETTINGS
# ---------------------------------------------
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
work_mem = 4MB

# ---------------------------------------------
# WRITE AHEAD LOG (WAL)
# ---------------------------------------------
wal_level = replica
wal_buffers = 16MB
max_wal_size = 1GB
min_wal_size = 80MB
checkpoint_completion_target = 0.9

# ---------------------------------------------
# QUERY TUNING
# ---------------------------------------------
random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100

# ---------------------------------------------
# LOGGING
# ---------------------------------------------
# Log destination - stderr for Docker log collection
logging_collector = off  # Disable file collection, log to Docker stdout/stderr
log_destination = 'stderr'  # Log to stderr for Docker to capture
# Note: JSON logging (jsonlog) is great but requires logging_collector=on which writes to files
# For Docker environments, we use stderr and parse with Promtail

# What to log - Enhanced for observability and security
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'
log_min_duration_statement = 1000  # Log queries taking more than 1 second
log_connections = on
log_disconnections = on
log_duration = off
log_statement = 'ddl'  # Log DDL statements for audit trail
log_lock_waits = on
log_temp_files = 0
log_checkpoints = on  # Log checkpoint activity
log_autovacuum_min_duration = 0  # Log all autovacuum runs

# Authentication and security logging
log_error_verbosity = default
log_hostname = on  # Include hostname in logs
log_line_prefix = '%m [%p] %q%u@%d '  # timestamp, PID, user@database

# Session and query tracking
log_statement_stats = off
log_parser_stats = off
log_planner_stats = off
log_executor_stats = off

# ---------------------------------------------
# AUTOVACUUM
# ---------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# ---------------------------------------------
# CLIENT CONNECTION DEFAULTS
# ---------------------------------------------
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

# ---------------------------------------------
# PERFORMANCE
# ---------------------------------------------
shared_preload_libraries = 'pg_stat_statements'

# ---------------------------------------------
# SECURITY
# ---------------------------------------------
password_encryption = scram-sha-256
ssl = off  # Enable this in production with proper certificates

# ---------------------------------------------
# ERROR REPORTING AND LOGGING
# ---------------------------------------------
log_min_messages = warning
log_min_error_statement = error

# ---------------------------------------------
# STATISTICS
# ---------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

