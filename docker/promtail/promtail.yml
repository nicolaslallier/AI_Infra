# ============================================
# Promtail Configuration
# AI Infrastructure Project - Log Collection
# ============================================

# Server configuration
server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

# Position tracking - where Promtail stores its position in log files
positions:
  filename: /tmp/positions.yaml

# Loki client configuration
clients:
  - url: http://loki:3100/loki/api/v1/push
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10
    timeout: 10s
    tenant_id: ai-infra

# Scrape configurations
scrape_configs:
  # ============================================
  # PostgreSQL Logs Collection
  # ============================================
  - job_name: postgres
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.service=postgres"]
    
    relabel_configs:
      # Add container labels as Loki labels
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'
      
      # Static labels for PostgreSQL logs
      - replacement: 'postgres'
        target_label: 'source'
      - replacement: 'ai-infra'
        target_label: 'cluster'
      - replacement: 'development'
        target_label: 'environment'
      - replacement: 'database'
        target_label: 'tier'
    
    pipeline_stages:
      # Parse plain text PostgreSQL logs (format: timestamp [pid] user@database LOG:  message)
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3} \w+) \[(?P<pid>\d+)\] (?:(?P<user>[^@]+)@(?P<database>\S+))?\s+(?P<level>\w+):\s+(?P<message>.*)$'
      
      # Extract and set timestamp
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05.000 MST'
      
      # Add labels from parsed fields
      - labels:
          level:
          user:
          database:
          pid:
      
      # PII Minimization - Redact sensitive data
      - replace:
          expression: '(?i)(password|secret|token|key)\s*[=:]\s*[''"]?[^\s''"]+[''"]?'
          replace: '${1}=***REDACTED***'
      
      # Redact email addresses (if present)
      - replace:
          expression: '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
          replace: '***EMAIL_REDACTED***'
      
      # Redact potential credit card numbers
      - replace:
          expression: '\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b'
          replace: '***CC_REDACTED***'
      
      # Set default log_type label
      - static_labels:
          log_type: 'database_log'
      
      # Enrich slow query logs (match on log line content)
      - match:
          selector: '{source="postgres"} |~ "duration:"'
          stages:
            - regex:
                expression: 'duration: (?P<duration>\d+\.?\d*) ms'
            - labels:
                duration:
            - static_labels:
                log_type: 'slow_query'
      
      # Tag connection logs (match on log line content)
      - match:
          selector: '{source="postgres"} |~ "connection"'
          stages:
            - static_labels:
                log_type: 'connection'
      
      # Tag authentication failures (match on label and log line)
      - match:
          selector: '{source="postgres", level="FATAL"} |~ "authentication"'
          stages:
            - static_labels:
                log_type: 'auth_failure'
                security_event: 'auth_failure'

  # ============================================
  # pgAdmin Logs Collection
  # ============================================
  - job_name: pgadmin
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.service=pgadmin"]
    
    relabel_configs:
      # Add container labels
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'
      
      # Static labels for pgAdmin logs
      - replacement: 'pgadmin'
        target_label: 'source'
      - replacement: 'ai-infra'
        target_label: 'cluster'
      - replacement: 'development'
        target_label: 'environment'
      - replacement: 'admin_tool'
        target_label: 'tier'
    
    pipeline_stages:
      # Parse JSON logs from pgAdmin
      - json:
          expressions:
            timestamp: timestamp
            level: level
            source: source
            message: message
            module: module
            function: function
            line: line
            user: user
            database: database
            request_id: request_id
            exception: exception
      
      # Set timestamp
      - timestamp:
          source: timestamp
          format: RFC3339
      
      # Add labels from JSON fields
      - labels:
          level:
          user:
          database:
          module:
      
      # PII Minimization - Redact passwords
      - replace:
          expression: '(?i)(password|passwd|pwd)\s*[=:]\s*[''"]?[^\s''"]+[''"]?'
          replace: '${1}=***REDACTED***'
      
      # Redact email addresses
      - replace:
          expression: '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
          replace: '***EMAIL_REDACTED***'
      
      # Redact connection strings
      - replace:
          expression: 'postgresql://[^@]+@[^/]+'
          replace: 'postgresql://***REDACTED***@***REDACTED***'
      
      # Template for log type
      - template:
          source: log_type
          template: 'admin_log'
      
      # Tag authentication events
      - match:
          selector: '{message=~".*[Ll]ogin.*|.*[Aa]uthentication.*"}'
          stages:
            - template:
                source: log_type
                template: 'authentication'
            - labels:
                event_type: 'authentication'
      
      # Tag administrative actions
      - match:
          selector: '{message=~".*CREATE.*|.*DROP.*|.*ALTER.*|.*GRANT.*|.*REVOKE.*"}'
          stages:
            - template:
                source: log_type
                template: 'admin_action'
            - labels:
                event_type: 'admin_action'
                security_event: 'admin_action'
      
      # Tag query execution
      - match:
          selector: '{message=~".*[Qq]uery.*|.*[Ee]xecute.*"}'
          stages:
            - template:
                source: log_type
                template: 'query_execution'
      
      # Tag errors
      - match:
          selector: '{level="ERROR"}'
          stages:
            - template:
                source: log_type
                template: 'error'
      
      # Tag failed authentication attempts (security)
      - match:
          selector: '{level="ERROR", message=~".*[Aa]uthentication.*[Ff]ailed.*|.*[Ll]ogin.*[Ff]ailed.*"}'
          stages:
            - template:
                source: log_type
                template: 'auth_failure'
            - labels:
                security_event: 'auth_failure'

  # ============================================
  # Keycloak Logs Collection
  # ============================================
  - job_name: keycloak
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.service=keycloak"]
    
    relabel_configs:
      # Add container labels
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'
      
      # Static labels for Keycloak logs
      - replacement: 'keycloak'
        target_label: 'source'
      - replacement: 'ai-infra'
        target_label: 'cluster'
      - replacement: 'development'
        target_label: 'environment'
      - replacement: 'identity_provider'
        target_label: 'tier'
    
    pipeline_stages:
      # Parse Keycloak logs (standard format: timestamp LEVEL [category] message)
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+(?P<level>\w+)\s+\[(?P<category>[^\]]+)\]\s+\((?P<thread>[^\)]+)\)\s+(?P<message>.*)$'
      
      # Extract and set timestamp
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05,000'
      
      # Add labels from parsed fields
      - labels:
          level:
          category:
      
      # PII Minimization - Redact sensitive data
      - replace:
          expression: '(?i)(password|secret|token|client_secret)\s*[=:]\s*[''"]?[^\s''"]+[''"]?'
          replace: '${1}=***REDACTED***'
      
      # Redact email addresses
      - replace:
          expression: '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
          replace: '***EMAIL_REDACTED***'
      
      # Set default log type
      - static_labels:
          log_type: 'identity_log'
      
      # Tag authentication events
      - match:
          selector: '{source="keycloak"} |~ "(?i)login|logout|authentication"'
          stages:
            - static_labels:
                log_type: 'authentication'
                event_type: 'auth_event'
      
      # Tag failed authentication attempts (security)
      - match:
          selector: '{source="keycloak", level=~"WARN|ERROR"} |~ "(?i)authentication.*failed|invalid.*credential|login.*failed"'
          stages:
            - static_labels:
                log_type: 'auth_failure'
                security_event: 'auth_failure'
      
      # Tag token events
      - match:
          selector: '{source="keycloak"} |~ "(?i)token"'
          stages:
            - static_labels:
                event_type: 'token_event'
      
      # Tag user management events
      - match:
          selector: '{source="keycloak"} |~ "(?i)user.*created|user.*updated|user.*deleted|role.*assigned"'
          stages:
            - static_labels:
                log_type: 'user_management'
                event_type: 'user_event'
                security_event: 'user_management'
      
      # Tag admin events
      - match:
          selector: '{source="keycloak", category=~".*admin.*"}'
          stages:
            - static_labels:
                log_type: 'admin_event'
                security_event: 'admin_action'
      
      # Tag errors
      - match:
          selector: '{level="ERROR"}'
          stages:
            - static_labels:
                log_type: 'error'

  # ============================================
  # MinIO Logs Collection
  # ============================================
  - job_name: minio
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["logging.source=minio"]
    
    relabel_configs:
      # Add container labels
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'
      
      # Static labels for MinIO logs
      - replacement: 'minio'
        target_label: 'source'
      - replacement: 'ai-infra'
        target_label: 'cluster'
      - replacement: 'development'
        target_label: 'environment'
      - replacement: 'object_storage'
        target_label: 'tier'
    
    pipeline_stages:
      # Parse JSON logs from MinIO (standard format)
      - json:
          expressions:
            time: time
            level: level
            api: api.name
            status: api.status_code
            method: api.method
            path: api.path
            host: api.host
            bucket: api.bucket
            object: api.object
            user_agent: api.user_agent
            remote_host: api.remote_host
            request_id: api.request_id
            message: message
            error: error
      
      # Set timestamp from MinIO's time field
      - timestamp:
          source: time
          format: RFC3339Nano
      
      # Add labels from JSON fields
      - labels:
          level:
          api:
          bucket:
          method:
          status:
      
      # PII Minimization - Redact access keys in logs
      - replace:
          expression: '(?i)(access[_-]?key|secret[_-]?key|authorization)\s*[=:]\s*[''"]?[^\s''"]+[''"]?'
          replace: '${1}=***REDACTED***'
      
      # Redact pre-signed URLs (contain sensitive tokens)
      - replace:
          expression: 'X-Amz-Signature=[A-Za-z0-9]+'
          replace: 'X-Amz-Signature=***REDACTED***'
      
      # Set default log type
      - static_labels:
          log_type: 'storage_log'
      
      # Tag API operations by type
      - match:
          selector: '{source="minio", method=~"PUT|POST"}'
          stages:
            - static_labels:
                operation_type: 'write'
                log_type: 'storage_write'
      
      - match:
          selector: '{source="minio", method="GET"}'
          stages:
            - static_labels:
                operation_type: 'read'
                log_type: 'storage_read'
      
      - match:
          selector: '{source="minio", method="DELETE"}'
          stages:
            - static_labels:
                operation_type: 'delete'
                log_type: 'storage_delete'
                security_event: 'object_deletion'
      
      # Tag authentication/authorization events
      - match:
          selector: '{source="minio", status=~"401|403"}'
          stages:
            - static_labels:
                log_type: 'auth_failure'
                security_event: 'access_denied'
      
      # Tag errors (4xx and 5xx responses)
      - match:
          selector: '{source="minio", status=~"[45]\\d{2}"}'
          stages:
            - static_labels:
                log_type: 'error'
      
      # Tag slow requests (if duration field exists)
      - match:
          selector: '{source="minio"} |~ "duration"'
          stages:
            - json:
                expressions:
                  duration_ns: api.duration_ns
            - labels:
                duration_ns:
      
      # Tag bucket operations (admin events)
      - match:
          selector: '{source="minio", api=~".*Bucket.*"}'
          stages:
            - static_labels:
                log_type: 'bucket_management'
                security_event: 'bucket_operation'
      
      # Tag IAM/policy events (admin events)
      - match:
          selector: '{source="minio", api=~".*Policy.*|.*User.*|.*ServiceAccount.*"}'
          stages:
            - static_labels:
                log_type: 'iam_management'
                security_event: 'iam_operation'

  # ============================================
  # System Logs (Optional - for debugging)
  # ============================================
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          __path__: /var/log/*log
          source: system
          cluster: ai-infra
          environment: development

# Limits configuration
limits_config:
  readline_rate_enabled: true
  readline_rate: 10000
  readline_burst: 20000

