version: '3.8'

# Development overrides for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  postgres:
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: dev_password
    command: ["postgres", "-c", "log_statement=all", "-c", "log_duration=on"]

  redis:
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass dev_password

  rabbitmq:
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_PASS: dev_password

  elasticsearch:
    environment:
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"
      - ELASTIC_PASSWORD=dev_password
    ports:
      - "9200:9200"

  grafana:
    environment:
      GF_SECURITY_ADMIN_PASSWORD: dev_password
      GF_LOG_LEVEL: debug

  prometheus:
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--log.level=debug'

  python-service:
    build:
      target: development
    volumes:
      - ./services/python-service:/app
      - python_venv:/app/.venv
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - RELOAD=true
    command: ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  nodejs-service:
    build:
      target: development
    volumes:
      - ./services/nodejs-service:/app
      - nodejs_modules:/app/node_modules
      - /app/node_modules
    environment:
      - DEBUG=*
      - LOG_LEVEL=debug
    command: ["npm", "run", "dev"]

volumes:
  python_venv:
  nodejs_modules:

