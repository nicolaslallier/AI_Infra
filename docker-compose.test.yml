# ============================================
# Docker Compose - Test Environment
# ============================================
# Isolated test environment for running integration and E2E tests
# Extends docker-compose.yml with test-specific configurations

version: '3.8'

services:
  # ============================================
  # TEST DATABASE - Isolated PostgreSQL
  # ============================================
  postgres-test:
    image: postgres:16-alpine
    container_name: ai_infra_postgres_test
    environment:
      POSTGRES_DB: test_db
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./docker/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./tests/fixtures/init-test-db.sql:/docker-entrypoint-initdb.d/init-test-db.sql:ro
    command: postgres -c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf
    networks:
      - test-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d test_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # NEWMAN - API Testing
  # ============================================
  newman:
    image: postman/newman:alpine
    container_name: ai_infra_newman
    volumes:
      - ./tests/api:/etc/newman
      - ./tests/reports:/reports
    networks:
      - test-net
    command: >
      run /etc/newman/collections/infrastructure-health.postman_collection.json
      --environment /etc/newman/environments/test.postman_environment.json
      --reporters cli,html
      --reporter-html-export /reports/newman-report.html
    depends_on:
      - nginx
    profiles:
      - test-api

  # ============================================
  # K6 - Performance Testing
  # ============================================
  k6:
    image: grafana/k6:latest
    container_name: ai_infra_k6
    volumes:
      - ./tests/performance:/scripts
      - ./tests/reports:/reports
    networks:
      - test-net
    environment:
      K6_OUT: json=/reports/k6-results.json
    command: run /scripts/load-test-infrastructure.js
    depends_on:
      - nginx
    profiles:
      - test-performance

  # ============================================
  # PLAYWRIGHT - E2E Testing
  # ============================================
  playwright:
    build:
      context: ./tests/e2e
      dockerfile: Dockerfile.playwright
    container_name: ai_infra_playwright
    volumes:
      - ./tests/e2e:/tests
      - ./tests/reports:/reports
    networks:
      - test-net
    environment:
      BASE_URL: http://nginx
      PWDEBUG: ${PWDEBUG:-0}
    command: npx playwright test
    depends_on:
      - nginx
    profiles:
      - test-e2e

  # ============================================
  # TEST NGINX - For isolated testing
  # ============================================
  nginx-test:
    image: nginx:alpine
    container_name: ai_infra_nginx_test
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - test-net
    profiles:
      - test-isolated

# ============================================
# TEST NETWORKS
# ============================================
networks:
  test-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.99.0.0/24

# ============================================
# TEST VOLUMES
# ============================================
volumes:
  postgres_test_data:
    driver: local

